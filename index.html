<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>House Hub</title>

<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="styles.css">

</head>
<body>

<h1>House Hub</h1>

<button id="login">Entrar com Google</button>
<button id="logout" style="display:none;">Sair</button>

<div id="conteudo" style="display:none;">
  <h2>Adicionar Groceries</h2>
  <form id="groceriesForm">
    <input type="text" id="gName" placeholder="Name" required />
    <select id="gType" required>
      <option value="">Escolha o tipo</option>
      <option value="Mercado">Mercado</option>
      <option value="Padaria">Padaria</option>
      <option value="Farmácia">Farmácia</option>
    </select>
    <input type="date" id="gDate" required />
    <input type="text" id="gTotalCost" placeholder="Total Cost (ex: R$ 20,42)" required />
    <button type="submit">Adicionar</button>
  </form>

  <h2>Adicionar Product</h2>
  <form id="productsForm">
    <input type="text" id="pName" placeholder="Name" required />
    <input type="text" id="pCategory" placeholder="Category" required />
    <input type="text" id="pFullPrice" placeholder="Full Price (ex: R$ 20,42)" required />
    <input type="number" id="pAmount" placeholder="Amount" required />
    <input type="text" id="pAmountUnit" placeholder="Amount Unit" required />
    <input type="text" id="pUnitPrice" placeholder="Unit Price (ex: R$ 20,42)" required />
    <input type="checkbox" id="pCheck" /> Checked
    <select id="pGroceryRef" required>
      <option value="">Escolha a compra</option>
    </select>
    <button type="submit">Adicionar</button>
  </form>

  <p id="status"></p>
</div>
<script type="module" src="main.js"></script>
<script>
  import { initializeFirebase } from "./js/components/DBConnection/firebase.js";

  initializeFirebase();

  // Login / Logout
  document.getElementById("login").onclick = async () => { try { await auth.signInWithPopup(provider); } catch(e){ alert(e.message); } };
  document.getElementById("logout").onclick = async () => await auth.signOut();

  auth.onAuthStateChanged(async user => {
    if(user){
      document.getElementById("login").style.display = "none";
      document.getElementById("logout").style.display = "block";
      document.getElementById("conteudo").style.display = "block";
      await updateGroceryOptions();
    } else {
      document.getElementById("login").style.display = "block";
      document.getElementById("logout").style.display = "none";
      document.getElementById("conteudo").style.display = "none";
    }
  });

  // Converte R$ para centavos
  function parseCurrency(value){
    return Math.round(parseFloat(value.replace("R$", "").replace(",", ".")) * 100);
  }

  // Converte input date para Timestamp
  function toTimestamp(value){
    return firebase.firestore.Timestamp.fromDate(new Date(value));
  }

  let lastGroceryRef = null; // guarda referência do último grocery adicionado

  // Adiciona Grocery
  document.getElementById("groceriesForm").onsubmit = async (e)=>{
    e.preventDefault();
    try{
      const groceryRef = await db.collection("Groceries").add({
        name: document.getElementById("gName").value.trim(),
        type: document.getElementById("gType").value,
        date: toTimestamp(document.getElementById("gDate").value),
        totalCostCents: parseCurrency(document.getElementById("gTotalCost").value)
      });
      lastGroceryRef = groceryRef;
      document.getElementById("status").innerText = "Groceries adicionada!";
      e.target.reset();
      await updateGroceryOptions();
    } catch(err){
      document.getElementById("status").innerText = "Erro: "+err.message;
    }
  };

  // Atualiza dropdown de Groceries para Products
  async function updateGroceryOptions(){
    const select = document.getElementById("pGroceryRef");
    select.innerHTML = '<option value="">Escolha a compra</option>';
    const snapshot = await db.collection("Groceries").orderBy("date", "desc").get();
    snapshot.forEach(doc => {
      const opt = document.createElement("option");
      opt.value = doc.id; // id do documento
      opt.textContent = `${doc.data().name} - ${doc.data().type} - ${doc.data().date.toDate().toLocaleDateString()}`;
      select.appendChild(opt);
    });
  }

  // Adiciona Product
  document.getElementById("productsForm").onsubmit = async (e)=>{
    e.preventDefault();
    try{
      const selectedGroceryId = document.getElementById("pGroceryRef").value;
      if(!selectedGroceryId) throw new Error("Selecione a compra correspondente");

      await db.collection("Products").add({
        name: document.getElementById("pName").value.trim(),
        category: document.getElementById("pCategory").value,
        fullPriceCents: parseCurrency(document.getElementById("pFullPrice").value),
        amount: Number(document.getElementById("pAmount").value),
        amountUnit: document.getElementById("pAmountUnit").value,
        unitPriceCents: parseCurrency(document.getElementById("pUnitPrice").value),
        check: document.getElementById("pCheck").checked,
        GroceriesRef: db.collection("Groceries").doc(selectedGroceryId)
      });
      document.getElementById("status").innerText = "Product adicionado!";
      e.target.reset();
    } catch(err){
      document.getElementById("status").innerText = "Erro: "+err.message;
    }
  };
</script>
</body>
</html>
