<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HouseHub - Controle Doméstico</title>

<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; background: #f7f7f7; }
input, button, select { display: block; width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
button { background: #4caf50; color: white; border: none; cursor: pointer; }
button:hover { background: #43a047; }
#login, #logout { margin-top: 20px; }
</style>
</head>
<body>

<h1>HouseHub - Controle Doméstico</h1>

<button id="login">Entrar com Google</button>
<button id="logout" style="display:none;">Sair</button>

<div id="conteudo" style="display:none;">

  <h2>Adicionar Groceries</h2>
  <form id="groceriesForm">
    <input type="text" id="gName" placeholder="Name" required />
    <select id="gType" required>
      <option value="">Escolha o tipo</option>
      <option value="Mercado">Mercado</option>
      <option value="Padaria">Padaria</option>
      <option value="Farmácia">Farmácia</option>
    </select>
    <input type="date" id="gDate" required />
    <input type="text" id="gTotalCost" placeholder="Total Cost (ex: R$ 20,42)" required />
    <button type="submit">Adicionar</button>
  </form>

  <h2>Adicionar Product</h2>
  <form id="productsForm">
    <input type="text" id="pName" placeholder="Name" required />
    <input type="text" id="pCategory" placeholder="Category" required />
    <input type="text" id="pFullPrice" placeholder="Full Price (ex: R$ 20,42)" required />
    <input type="number" id="pAmount" placeholder="Amount" required />
    <input type="text" id="pAmountUnit" placeholder="Amount Unit" required />
    <input type="text" id="pUnitPrice" placeholder="Unit Price (ex: R$ 20,42)" required />
    <input type="checkbox" id="pCheck" /> Checked
    <input type="date" id="pGroceryDate" required />
    <button type="submit">Adicionar</button>
  </form>

  <p id="status"></p>
</div>

<script>
  // Config Firebase do seu projeto
  const firebaseConfig = {
    apiKey: "AIzaSyA_CkIgswx9DClgDI6UbWJ8JBH2j8Qndbw",
    authDomain: "househub-ba60c.firebaseapp.com",
    projectId: "househub-ba60c",
    storageBucket: "househub-ba60c.appspot.com",
    messagingSenderId: "799328107995",
    appId: "1:799328107995:web:5d469a48ed60a0e479fbfe"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const provider = new firebase.auth.GoogleAuthProvider();

  // Login/Logout
  document.getElementById("login").onclick = async () => {
    try { await auth.signInWithPopup(provider); } 
    catch(e){ alert(e.message); }
  };
  document.getElementById("logout").onclick = async () => { await auth.signOut(); };

  auth.onAuthStateChanged(user => {
    const loggedIn = !!user;
    document.getElementById("login").style.display = loggedIn ? "none" : "block";
    document.getElementById("logout").style.display = loggedIn ? "block" : "none";
    document.getElementById("conteudo").style.display = loggedIn ? "block" : "none";
  });

  // Converte R$ para centavos
  function parseCurrency(value){
    const cleaned = value.replace(/[R$\s]/g,"").replace(",",".");
    const num = parseFloat(cleaned);
    if(isNaN(num)) throw new Error("Valor inválido: "+value);
    return Math.round(num*100);
  }

  // Converte input date para Timestamp do Firestore
  function toTimestamp(value){
    if(!value) throw new Error("Data inválida: "+value);
    const d = new Date(value);
    if(isNaN(d.getTime())) throw new Error("Data inválida: "+value);
    return firebase.firestore.Timestamp.fromDate(d);
  }

  // Submit Groceries
  document.getElementById("groceriesForm").onsubmit = async (e) => {
    e.preventDefault(); // previne envio padrão do form

    try {
      const dateValue = document.getElementById("gDate").value;
      const totalCostValue = document.getElementById("gTotalCost").value;

      if (!dateValue || !totalCostValue) throw new Error("Preencha todos os campos obrigatórios");

      await db.collection("Groceries").add({
        name: document.getElementById("gName").value.trim(),
        type: document.getElementById("gType").value,
        date: toTimestamp(dateValue),
        totalCostCents: parseCurrency(totalCostValue)
      });

      document.getElementById("status").innerText = "Groceries adicionada!";
      e.target.reset();
    } catch (err) {
      document.getElementById("status").innerText = "Erro: " + err.message;
    }
  };


  // Submit Products
  document.getElementById("productsForm").onsubmit = async (e) => {
    e.preventDefault();
    const statusEl = document.getElementById("status");

    try {
      const productData = {
        name: document.getElementById("pName").value.trim(),
        category: document.getElementById("pCategory").value.trim(),
        fullPriceCents: parseCurrency(document.getElementById("pFullPrice").value.trim()),
        amount: Number(document.getElementById("pAmount").value),
        amountUnit: document.getElementById("pAmountUnit").value.trim(),
        unitPriceCents: parseCurrency(document.getElementById("pUnitPrice").value.trim()),
        check: document.getElementById("pCheck").checked,
        groceryDate: toTimestamp(document.getElementById("pGroceryDate").value)
      };
      console.log("Enviando Product:", productData);
      await db.collection("Products").add(productData);
      statusEl.innerText = "Product adicionado!";
      e.target.reset();
    } catch(err){
      console.error(err);
      statusEl.innerText = "Erro: "+err.message;
    }
  };
</script>

</body>
</html>
